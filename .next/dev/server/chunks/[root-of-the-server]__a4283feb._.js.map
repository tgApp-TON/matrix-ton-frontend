{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/stanislavozarchuk/Projects/matrix-ton/frontend/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey);\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM;AAEC,MAAM,WAAW,IAAA,4MAAY,EAAC,aAAa"}},
    {"offset": {"line": 59, "column": 0}, "map": {"version":3,"sources":["file:///Users/stanislavozarchuk/Projects/matrix-ton/frontend/app/api/user/referrals/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { supabase } from '@/lib/supabase';\n\n// Recursive function to count all referrals in the tree\nasync function countReferralTree(userId: number): Promise<number> {\n  const { data: directRefs } = await supabase\n    .from('User')\n    .select('id')\n    .eq('referrerId', userId);\n  \n  if (!directRefs || directRefs.length === 0) return 0;\n  \n  let total = directRefs.length;\n  \n  // Count referrals of each direct referral (recursive)\n  for (const ref of directRefs) {\n    total += await countReferralTree(ref.id);\n  }\n  \n  return total;\n}\n\nexport async function GET(request: NextRequest) {\n  const { searchParams } = new URL(request.url);\n  const userId = searchParams.get('userId');\n\n  if (!userId) {\n    return NextResponse.json({ error: 'User ID required' }, { status: 400 });\n  }\n\n  try {\n    // Get DIRECT referrals (only those who came via this user's ref link)\n    const { data: directReferrals, error } = await supabase\n      .from('User')\n      .select(`\n        id,\n        nickname,\n        telegramUsername,\n        accountCreatedDate,\n        isVerified\n      `)\n      .eq('referrerId', parseInt(userId))\n      .order('accountCreatedDate', { ascending: false });\n\n    if (error) throw error;\n\n    // Get stats for each direct referral\n    const referralsWithStats = await Promise.all(\n      (directReferrals || []).map(async (ref) => {\n        // Count active tables\n        const { data: tables } = await supabase\n          .from('Table')\n          .select('id')\n          .eq('userId', ref.id)\n          .eq('status', 'ACTIVE');\n\n        // Count their direct referrals\n        const { data: subReferrals } = await supabase\n          .from('User')\n          .select('id')\n          .eq('referrerId', ref.id);\n\n        // Calculate earnings (sum of completed table positions after 10% commission)\n        const { data: positions } = await supabase\n          .from('TablePosition')\n          .select('amountPaid')\n          .eq('partnerUserId', ref.id)\n          .eq('status', 'PAID_OUT');\n\n        const totalEarnings = (positions || []).reduce((sum, pos) => {\n          // Subtract 10% commission\n          const afterCommission = parseFloat(pos.amountPaid || '0') * 0.9;\n          return sum + afterCommission;\n        }, 0);\n\n        return {\n          ...ref,\n          activeTables: tables?.length || 0,\n          referralsCount: subReferrals?.length || 0,\n          totalEarnings: Math.round(totalEarnings * 100) / 100 // Round to 2 decimals\n        };\n      })\n    );\n\n    // Count total tree (recursive - all levels)\n    const totalTreeCount = await countReferralTree(parseInt(userId));\n\n    // Get user's referrer (upline) info\n    let upline = null;\n    const { data: currentUser } = await supabase\n      .from('User')\n      .select('referrerId')\n      .eq('id', parseInt(userId))\n      .single();\n\n    if (currentUser?.referrerId && currentUser.referrerId !== 1) {\n      // Only fetch if referrer is NOT MASTER\n      const { data: referrerData } = await supabase\n        .from('User')\n        .select('id, nickname, telegramUsername')\n        .eq('id', currentUser.referrerId)\n        .single();\n      \n      if (referrerData) {\n        // Get referrer's stats\n        const { data: refTables } = await supabase\n          .from('Table')\n          .select('id')\n          .eq('userId', referrerData.id)\n          .eq('status', 'ACTIVE');\n        \n        const { data: refReferrals } = await supabase\n          .from('User')\n          .select('id')\n          .eq('referrerId', referrerData.id);\n        \n        upline = {\n          ...referrerData,\n          activeTables: refTables?.length || 0,\n          referralsCount: refReferrals?.length || 0\n        };\n      }\n    }\n\n    return NextResponse.json({ \n      success: true, \n      directReferrals: referralsWithStats, // Only direct workers\n      directCount: directReferrals?.length || 0, // Count of direct referrals\n      totalTreeCount, // Total in entire tree (including sub-referrals)\n      upline, // Add upline info\n      stats: {\n        direct: directReferrals?.length || 0,\n        total: totalTreeCount\n      }\n    });\n  } catch (error) {\n    console.error('Referrals fetch error:', error);\n    return NextResponse.json({ \n      error: 'Failed to fetch referrals' \n    }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,wDAAwD;AACxD,eAAe,kBAAkB,MAAc;IAC7C,MAAM,EAAE,MAAM,UAAU,EAAE,GAAG,MAAM,yIAAQ,CACxC,IAAI,CAAC,QACL,MAAM,CAAC,MACP,EAAE,CAAC,cAAc;IAEpB,IAAI,CAAC,cAAc,WAAW,MAAM,KAAK,GAAG,OAAO;IAEnD,IAAI,QAAQ,WAAW,MAAM;IAE7B,sDAAsD;IACtD,KAAK,MAAM,OAAO,WAAY;QAC5B,SAAS,MAAM,kBAAkB,IAAI,EAAE;IACzC;IAEA,OAAO;AACT;AAEO,eAAe,IAAI,OAAoB;IAC5C,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,SAAS,aAAa,GAAG,CAAC;IAEhC,IAAI,CAAC,QAAQ;QACX,OAAO,4JAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAmB,GAAG;YAAE,QAAQ;QAAI;IACxE;IAEA,IAAI;QACF,sEAAsE;QACtE,MAAM,EAAE,MAAM,eAAe,EAAE,KAAK,EAAE,GAAG,MAAM,yIAAQ,CACpD,IAAI,CAAC,QACL,MAAM,CAAC,CAAC;;;;;;MAMT,CAAC,EACA,EAAE,CAAC,cAAc,SAAS,SAC1B,KAAK,CAAC,sBAAsB;YAAE,WAAW;QAAM;QAElD,IAAI,OAAO,MAAM;QAEjB,qCAAqC;QACrC,MAAM,qBAAqB,MAAM,QAAQ,GAAG,CAC1C,CAAC,mBAAmB,EAAE,EAAE,GAAG,CAAC,OAAO;YACjC,sBAAsB;YACtB,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,yIAAQ,CACpC,IAAI,CAAC,SACL,MAAM,CAAC,MACP,EAAE,CAAC,UAAU,IAAI,EAAE,EACnB,EAAE,CAAC,UAAU;YAEhB,+BAA+B;YAC/B,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,yIAAQ,CAC1C,IAAI,CAAC,QACL,MAAM,CAAC,MACP,EAAE,CAAC,cAAc,IAAI,EAAE;YAE1B,6EAA6E;YAC7E,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,MAAM,yIAAQ,CACvC,IAAI,CAAC,iBACL,MAAM,CAAC,cACP,EAAE,CAAC,iBAAiB,IAAI,EAAE,EAC1B,EAAE,CAAC,UAAU;YAEhB,MAAM,gBAAgB,CAAC,aAAa,EAAE,EAAE,MAAM,CAAC,CAAC,KAAK;gBACnD,0BAA0B;gBAC1B,MAAM,kBAAkB,WAAW,IAAI,UAAU,IAAI,OAAO;gBAC5D,OAAO,MAAM;YACf,GAAG;YAEH,OAAO;gBACL,GAAG,GAAG;gBACN,cAAc,QAAQ,UAAU;gBAChC,gBAAgB,cAAc,UAAU;gBACxC,eAAe,KAAK,KAAK,CAAC,gBAAgB,OAAO,IAAI,sBAAsB;YAC7E;QACF;QAGF,4CAA4C;QAC5C,MAAM,iBAAiB,MAAM,kBAAkB,SAAS;QAExD,oCAAoC;QACpC,IAAI,SAAS;QACb,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,yIAAQ,CACzC,IAAI,CAAC,QACL,MAAM,CAAC,cACP,EAAE,CAAC,MAAM,SAAS,SAClB,MAAM;QAET,IAAI,aAAa,cAAc,YAAY,UAAU,KAAK,GAAG;YAC3D,uCAAuC;YACvC,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,yIAAQ,CAC1C,IAAI,CAAC,QACL,MAAM,CAAC,kCACP,EAAE,CAAC,MAAM,YAAY,UAAU,EAC/B,MAAM;YAET,IAAI,cAAc;gBAChB,uBAAuB;gBACvB,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,MAAM,yIAAQ,CACvC,IAAI,CAAC,SACL,MAAM,CAAC,MACP,EAAE,CAAC,UAAU,aAAa,EAAE,EAC5B,EAAE,CAAC,UAAU;gBAEhB,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,yIAAQ,CAC1C,IAAI,CAAC,QACL,MAAM,CAAC,MACP,EAAE,CAAC,cAAc,aAAa,EAAE;gBAEnC,SAAS;oBACP,GAAG,YAAY;oBACf,cAAc,WAAW,UAAU;oBACnC,gBAAgB,cAAc,UAAU;gBAC1C;YACF;QACF;QAEA,OAAO,4JAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,iBAAiB;YACjB,aAAa,iBAAiB,UAAU;YACxC;YACA;YACA,OAAO;gBACL,QAAQ,iBAAiB,UAAU;gBACnC,OAAO;YACT;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,4JAAY,CAAC,IAAI,CAAC;YACvB,OAAO;QACT,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF"}}]
}