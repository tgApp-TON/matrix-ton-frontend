generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum UserRole {
  OWNER
  FOUNDER
  PARTNER
  USER
}

enum TableStatus {
  ACTIVE
  CLOSED
}

enum PayoutMethod {
  INSTANT
  BATCH
}

enum PositionStatus {
  PAID_OUT
  PENDING_PAYOUT
  HELD_FOR_AUTOPURCHASE
  PLATFORM_INCOME
}

// Models
model User {
  id                 Int       @id @default(autoincrement())
  
  // Telegram
  telegramId         BigInt    @unique
  telegramUsername   String?
  telegramPhone      String?
  isPremium          Boolean
  accountCreatedDate DateTime
  
  // Profile
  nickname           String    @unique @db.VarChar(20)
  tonWallet          String    @unique @db.VarChar(255)
  
  // Role
  role               UserRole  @default(USER)
  
  // Referral
  referrerId         Int?
  referrer           User?     @relation("Referrals", fields: [referrerId], references: [id])
  referrals          User[]    @relation("Referrals")
  referralCode       String?   @unique @db.VarChar(10)
  directReferrals    Int       @default(0)
  totalNetwork       Int       @default(0)
  
  // Stats
  totalEarned        Decimal   @default(0) @db.Decimal(20, 9)
  totalInvested      Decimal   @default(0) @db.Decimal(20, 9)
  pendingPayout      Decimal   @default(0) @db.Decimal(20, 9)
  
  // Payout settings
  payoutMethod       PayoutMethod @default(BATCH)
  
  // Security
  isVerified         Boolean   @default(true)
  fraudScore         Int       @default(0)
  ipAddress          String?
  deviceInfo         String?
  
  // Timestamps
  registeredAt       DateTime  @default(now())
  lastActive         DateTime  @default(now())
  
  // Relations
  tables             Table[]
  partnerConfig      PartnerConfig?
  pendingPayouts     PendingPayout[]
  activityLog        ActivityLog[]
  userStats          UserStats?
}

model Table {
  id           Int         @id @default(autoincrement())
  userId       Int
  user         User        @relation(fields: [userId], references: [id])
  
  tableNumber  Int
  status       TableStatus @default(ACTIVE)
  cycleNumber  Int         @default(1)
  
  createdAt    DateTime    @default(now())
  closedAt     DateTime?
  
  positions    TablePosition[]
  
  @@unique([userId, tableNumber])
  @@index([status, tableNumber])
}

model TablePosition {
  id              Int      @id @default(autoincrement())
  tableId         Int
  table           Table    @relation(fields: [tableId], references: [id])
  
  partnerUserId   Int
  partnerNickname String
  
  position        Int
  cycleNumber     Int
  
  amountPaid      Decimal  @db.Decimal(20, 9)
  amountReceived  Decimal  @db.Decimal(20, 9)
  fee             Decimal? @db.Decimal(20, 9)
  
  status          PositionStatus
  txHash          String?
  
  createdAt       DateTime @default(now())
  processedAt     DateTime?
  
  @@index([tableId, position])
}

model Transaction {
  id          Int      @id @default(autoincrement())
  
  txHash      String   @unique
  fromAddress String
  toAddress   String
  
  amount      Decimal  @db.Decimal(20, 9)
  fee         Decimal  @db.Decimal(20, 9)
  
  type        String
  tableNumber Int?
  comment     String?
  
  status      String   @default("confirmed")
  createdAt   DateTime @default(now())
  
  @@index([toAddress, createdAt])
  @@index([type, tableNumber])
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  
  action    String
  details   Json
  amount    Decimal? @db.Decimal(20, 9)
  
  createdAt DateTime @default(now())
  
  @@index([userId, createdAt])
}

model UserStats {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  user            User     @relation(fields: [userId], references: [id])
  
  totalEarned     Decimal  @default(0) @db.Decimal(20, 9)
  totalReferrals  Int      @default(0)
  
  table1Cycles    Int      @default(0)
  table2Cycles    Int      @default(0)
  table3Cycles    Int      @default(0)
  table4Cycles    Int      @default(0)
  table5Cycles    Int      @default(0)
  table6Cycles    Int      @default(0)
  table7Cycles    Int      @default(0)
  table8Cycles    Int      @default(0)
  table9Cycles    Int      @default(0)
  table10Cycles   Int      @default(0)
  table11Cycles   Int      @default(0)
  table12Cycles   Int      @default(0)
  
  totalCycles     Int      @default(0)
  activeTables    Int      @default(0)
  
  updatedAt       DateTime @updatedAt
}

model PartnerConfig {
  id                 Int      @id @default(autoincrement())
  userId             Int      @unique
  user               User     @relation(fields: [userId], references: [id])
  
  autoActivateTables Int[]
  activationTrigger  String   @default("first_table_purchase")
  tablesActivated    Boolean  @default(false)
  activatedAt        DateTime?
  notes              String?
  
  createdAt          DateTime @default(now())
}

model PendingPayout {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  
  amount          Decimal  @db.Decimal(20, 9)
  reason          String
  tableNumber     Int?
  
  status          String   @default("pending")
  payoutMethod    PayoutMethod
  
  batchId         Int?
  txHash          String?
  
  createdAt       DateTime @default(now())
  processedAt     DateTime?
  
  @@index([userId, status])
  @@index([status, payoutMethod])
}
